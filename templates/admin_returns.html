<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Returns Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-gray-800">
    {% include 'partials/navbar.html' %}

    <div class="container mx-auto p-4 md:p-8 space-y-6">
        {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="p-4 rounded-md {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-semibold">Open Returns</h2>
                    <p class="text-sm text-gray-500">Manage approval, logistics, inspection, and refund execution.</p>
                </div>
                <a href="{{ url_for('returns.admin_returns_dashboard') }}" class="text-sm text-blue-500 hover:underline">Refresh</a>
            </div>

            {% if return_requests %}
            <div class="space-y-6">
                {% for req in return_requests %}
                <div class="border rounded-lg p-4">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2">
                        <div>
                            <p class="font-semibold">RMA {{ req.rma_number or ('RMA-' ~ req.returnRequestID) }}</p>
                            <p class="text-xs text-gray-500">Sale #{{ req.saleID }} · Customer #{{ req.customerID }}</p>
                        </div>
                        <div class="space-x-2">
                            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800">{{ req.status.value if req.status else req.status }}</span>
                            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-700">{{ req.reason.value if req.reason else req.reason }}</span>
                        </div>
                    </div>

                    <div class="mt-3 grid md:grid-cols-4 gap-3 text-sm">
                        <div>
                            <p class="text-gray-500 uppercase text-xs">Items</p>
                            <ul class="list-disc list-inside">
                                {% for item in req.return_items %}
                                <li>{{ item.sale_item.product.name if item.sale_item and item.sale_item.product else 'Item' }} × {{ item.quantity }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div>
                            <p class="text-gray-500 uppercase text-xs">Shipment</p>
                            {% if req.shipment %}
                                <p>{{ req.shipment.carrier }} · {{ req.shipment.tracking_number }}</p>
                                <p class="text-xs text-gray-500">Shipped: {{ req.shipment.shipped_at.strftime('%Y-%m-%d') if req.shipment.shipped_at }}</p>
                                <p class="text-xs text-gray-500">Received: {{ req.shipment.received_at.strftime('%Y-%m-%d') if req.shipment.received_at }}</p>
                            {% else %}
                                <p class="text-gray-500">Pending</p>
                            {% endif %}
                        </div>
                        <div>
                            <p class="text-gray-500 uppercase text-xs">Inspection</p>
                            {% if req.inspection %}
                                <p>{{ req.inspection.result.value if req.inspection.result else req.inspection.result }}</p>
                                <p class="text-xs text-gray-500">By {{ req.inspection.inspected_by }}</p>
                            {% else %}
                                <p class="text-gray-500">Not started</p>
                            {% endif %}
                        </div>
                        <div>
                            <p class="text-gray-500 uppercase text-xs">Refund</p>
                            {% if req.refund %}
                                <p>{{ req.refund.status.value if req.refund.status else req.refund.status }} · ${{ "%.2f"|format(req.refund.amount) }}</p>
                            {% else %}
                                <p class="text-gray-500">Not initiated</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-4 grid md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-3">
                            {% if req.status in ['PENDING_AUTHORIZATION', 'PENDING_CUSTOMER_INFO'] or req.status == ReturnRequestStatus.PENDING_AUTHORIZATION %}
                            <form method="POST" action="{{ url_for('returns.admin_authorize_return', return_id=req.returnRequestID) }}" class="bg-gray-50 p-3 rounded-md space-y-2">
                                <p class="text-xs text-gray-500 uppercase">Authorization</p>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center space-x-1 text-green-700">
                                        <input type="radio" name="decision" value="approve" checked>
                                        <span>Approve</span>
                                    </label>
                                    <label class="flex items-center space-x-1 text-red-700">
                                        <input type="radio" name="decision" value="reject">
                                        <span>Reject</span>
                                    </label>
                                </div>
                                <textarea name="decision_notes" class="w-full border rounded p-2" rows="2" placeholder="Notes (optional)"></textarea>
                                <button class="w-full bg-blue-600 text-white py-1.5 rounded-md text-sm">Submit decision</button>
                            </form>
                            {% endif %}

                            {% if req.status == ReturnRequestStatus.AUTHORIZED %}
                            <form method="POST" action="{{ url_for('returns.admin_record_shipment', return_id=req.returnRequestID) }}" class="bg-gray-50 p-3 rounded-md space-y-2">
                                <p class="text-xs text-gray-500 uppercase">Record Shipment</p>
                                <input name="carrier" class="w-full border rounded p-2 text-sm" placeholder="Carrier e.g., DHL" required>
                                <input name="tracking_number" class="w-full border rounded p-2 text-sm" placeholder="Tracking #" required>
                                <button class="w-full bg-blue-600 text-white py-1.5 rounded-md text-sm">Save shipment</button>
                            </form>
                            {% endif %}

                            {% if req.status == ReturnRequestStatus.IN_TRANSIT %}
                            <form method="POST" action="{{ url_for('returns.admin_mark_received', return_id=req.returnRequestID) }}" class="bg-gray-50 p-3 rounded-md space-y-2">
                                <p class="text-xs text-gray-500 uppercase">Mark Received</p>
                                <button class="w-full bg-blue-600 text-white py-1.5 rounded-md text-sm">Confirm arrival</button>
                            </form>
                            {% endif %}
                        </div>

                        <div class="space-y-3">
                            {% if req.status in [ReturnRequestStatus.RECEIVED, ReturnRequestStatus.UNDER_INSPECTION] %}
                            <form method="POST" action="{{ url_for('returns.admin_record_inspection', return_id=req.returnRequestID) }}" class="bg-gray-50 p-3 rounded-md space-y-2">
                                <p class="text-xs text-gray-500 uppercase">Inspection</p>
                                <select name="result" class="w-full border rounded p-2 text-sm" required>
                                    {% for result in InspectionResult %}
                                    <option value="{{ result.value }}">{{ result.name.replace('_', ' ').title() }}</option>
                                    {% endfor %}
                                </select>
                                <input name="inspected_by" class="w-full border rounded p-2 text-sm" placeholder="Inspector name" value="QA Team">
                                <textarea name="notes" class="w-full border rounded p-2 text-sm" rows="2" placeholder="Notes"></textarea>
                                <button class="w-full bg-blue-600 text-white py-1.5 rounded-md text-sm">Save inspection</button>
                            </form>
                            {% endif %}

                            {% if req.status == ReturnRequestStatus.APPROVED %}
                            <form method="POST" action="{{ url_for('returns.admin_initiate_refund', return_id=req.returnRequestID) }}" class="bg-gray-50 p-3 rounded-md space-y-2">
                                <p class="text-xs text-gray-500 uppercase">Refund</p>
                                <select name="method" class="w-full border rounded p-2 text-sm">
                                    {% for method in RefundMethod %}
                                    <option value="{{ method.value }}">{{ method.name.replace('_', ' ').title() }}</option>
                                    {% endfor %}
                                </select>
                                <button class="w-full bg-green-600 text-white py-1.5 rounded-md text-sm">Trigger refund</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500">No return requests found.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>

