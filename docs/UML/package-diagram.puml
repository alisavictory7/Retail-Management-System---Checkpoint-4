@startuml Package Diagram - CP4 Architecture View

!theme plain
skinparam packageStyle rectangle
skinparam dpi 120
skinparam packageBackgroundColor #F4ECFE
skinparam packageBorderColor #6C3FA7
skinparam noteBackgroundColor #FFF3CD
skinparam noteBorderColor #856404

left to right direction

package "Core Platform" {
    [src/config.py] as Config
    [src/main.py] as Main
    [src/models.py] as Models
    [src/database.py] as Database
}

package "Experience Layer" {
    [src/blueprints/returns.py] as ReturnsBP
    [templates/] as Templates
    [templates/order_history.html] as OrderHistoryTpl
    [templates/admin_dashboard.html] as DashboardTpl
    [templates/manage_store.html] as ManageStoreTpl
}

package "Domain Services" {
    [src/services/returns_service.py] as ReturnsSvc
    [src/services/refund_service.py] as RefundSvc
    [src/services/payment_service.py] as PaymentSvc
    [src/services/inventory_service.py] as InventorySvc
}

package "CP4 Feature Services" #E8F5E9 {
    [src/services/history_service.py] as HistorySvc
    [src/services/low_stock_alert_service.py] as LowStockSvc
    [src/services/notification_service.py] as NotificationSvc
    [src/services/flash_sale_service.py] as FlashSaleSvc
}

package "Reliability & Observability" {
    [src/tactics/manager.py] as TacticsManager
    [src/tactics/availability.py] as Availability
    [src/tactics/performance.py] as Performance
    [src/observability/metrics.py] as Metrics
    [src/observability/business_metrics.py] as BusinessMetrics
}

package "Deployment & Tooling" as Deploy {
    [Dockerfile]
    [deploy/dockercompose.yml]
    [docker/entrypoint.sh]
    [scripts/bootstrap_super_admin.py]
}

package "Tests" as TestsPkg {
    [tests/test_returns_service.py]
    [tests/test_returns_api.py]
    [tests/test_business_metrics.py]
    [tests/test_quality_scenario_validation.py]
}

package "Docs" as DocsPkg {
    [docs/ADR/ADR_CP4.md]
    [docs/UML/*.puml]
    [Checkpoint3.md]
    [docs/Runbook.md]
}

Main --> ReturnsBP
ReturnsBP --> ReturnsSvc
ReturnsBP --> Templates

ReturnsSvc --> RefundSvc
ReturnsSvc --> InventorySvc
RefundSvc --> PaymentSvc
ReturnsSvc --> Models
InventorySvc --> Models

' CP4 Feature connections
Main --> HistorySvc : /order-history route
Main --> LowStockSvc : /admin/dashboard
Main --> NotificationSvc : context_processor + API
Main --> FlashSaleSvc : /admin/manage-store
HistorySvc --> Models : queries Sales, Returns
LowStockSvc --> Models : monitors Products
FlashSaleSvc --> Models : manages FlashSale
NotificationSvc ..> ReturnsSvc : Pub-Sub subscriber
InventorySvc ..> LowStockSvc : publishes stock events
OrderHistoryTpl --> Templates
DashboardTpl --> Templates
ManageStoreTpl --> Templates

TacticsManager --> Availability
TacticsManager --> Performance
Main --> TacticsManager
TacticsManager --> Metrics
BusinessMetrics --> Metrics
BusinessMetrics --> Models

Deploy --> Main : containerizes
Deploy --> Database : seeds

TestsPkg --> ReturnsSvc
TestsPkg --> ReturnsBP
TestsPkg --> BusinessMetrics
TestsPkg --> TacticsManager

DocsPkg --> Deploy : instructions
DocsPkg --> BusinessMetrics : diagrams & runbook

note right of HistorySvc
  CP4 Feature 2.1
  Order History Filtering
  - Status/date/keyword filters
  - Layered service pattern
end note

note right of LowStockSvc
  CP4 Feature 2.2
  Low Stock Alerts
  - Pub-Sub pattern
  - Configurable threshold
end note

note right of NotificationSvc
  CP4 Feature 2.3
  RMA Notifications
  - In-memory store
  - Navbar badge count
end note

@enduml
