@startuml Deployment Diagram - Dockerized Client + Database Architecture (CP4)

!theme plain
skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam dpi 120
skinparam componentFontSize 10
skinparam componentBackgroundColor #E3F2FD
skinparam componentBorderColor #1976D2
skinparam packageBackgroundColor #F3E5F5
skinparam packageBorderColor #7B1FA2
skinparam databaseBackgroundColor #E8F5E9
skinparam databaseBorderColor #2E7D32
skinparam arrowColor #1F2933
skinparam noteBackgroundColor #FFF3CD
skinparam noteBorderColor #856404

node "Customer Browser" as CustomerBrowser
node "Admin Browser" as AdminBrowser

node "Docker Host" {
    frame "docker compose stack" {
        node "web\n(Gunicorn + Flask)" as WebContainer {
            component "Flask Application\n(main.py + blueprints)" as Flask
            component "Returns & Refunds Module\n(services + templates)" as ReturnsModule
            component "Quality Tactics Manager" as QTM
            component "Unified Admin Dashboard\n(/admin/dashboard)" as Dashboard
            component "Manage Store Portal\n(/admin/manage-store)" as ManageStore
            
            component "CP4 Feature Services" as CP4Services #E8F5E9 {
                component "HistoryService\n(Order Filtering)" as HistorySvc
                component "LowStockAlertService\n(Pub-Sub)" as LowStockSvc
                component "NotificationService\n(RMA Updates)" as NotificationSvc
                component "FlashSaleService\n(Promotions)" as FlashSaleSvc
            }
        }

        node "db\n(PostgreSQL 15)" as DbContainer {
            database "Retail DB\n(core tables + RMA + metrics)" as RetailDB
            artifact "Persistent Volume\npostgres_data" as Volume
        }
    }
}

node "External Services" {
    component "Mock Payment Gateway" as PaymentGateway
    component "Partner APIs" as PartnerAPIs
}

node "Monitoring Tooling" {
    component "Structured Logs" as Logs
    component "Metrics Snapshot\n(/admin/metrics)" as MetricsEndpoint
}

CustomerBrowser --> Flask : HTTPS\nstorefront & checkout
CustomerBrowser --> HistorySvc : /order-history
CustomerBrowser --> NotificationSvc : /api/notifications
AdminBrowser --> Dashboard : HTTPS\nadmin console
AdminBrowser --> LowStockSvc : /api/admin/low-stock
Flask --> ReturnsModule : invoke RMA workflow
Flask --> QTM : apply tactics
Flask --> CP4Services : CP4 feature routes
QTM --> RetailDB : read/write\nCircuitBreakerState\nOrderQueue
ReturnsModule --> RetailDB : persist RMA entities
ReturnsModule --> NotificationSvc : publish status changes
Dashboard --> MetricsEndpoint : poll JSON
Dashboard --> LowStockSvc : display alerts
Flask --> RetailDB : SQLAlchemy ORM
HistorySvc --> RetailDB : query history
RetailDB --> Volume : data files

Flask --> PaymentGateway : Refund / charge
Flask --> PartnerAPIs : Catalog sync
Logs <- Flask : structured JSON
MetricsEndpoint <- QTM : counters/histograms/events

note right of WebContainer
  Flask container bundles:
  - Gunicorn workers
  - Returns blueprint + services
  - Observability middleware
  - Quality tactics manager
  - CP4 Feature Services (in-memory)
end note

note right of DbContainer
  Postgres container bootstraps via
  `db/init.sql`, migrations, and
  demo seeds. Volumes keep state
  between compose restarts.
end note

note right of CP4Services
  Checkpoint 4 Features:
  - Order History with filters (2.1)
  - Low Stock Alerts (2.2)
  - RMA Notifications (2.3)
  - All use Pub-Sub / Layers patterns
end note

note right of Dashboard
  Unified Admin Dashboard:
  - Portal cards (Users, Store, Returns)
  - Business metrics & KPIs
  - Scenario A.1 and P.1 monitoring
  - HTTP latency & events
end note

note right of ManageStore
  Manage Store Portal:
  - Product CRUD operations
  - Low stock alerts (Pub-Sub)
  - Flash sale management
  - Tabbed interface
end note

@enduml
